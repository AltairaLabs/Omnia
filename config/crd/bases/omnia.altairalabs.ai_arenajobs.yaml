---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: arenajobs.omnia.altairalabs.ai
spec:
  group: omnia.altairalabs.ai
  names:
    kind: ArenaJob
    listKind: ArenaJobList
    plural: arenajobs
    singular: arenajob
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.sourceRef.name
      name: Source
      type: string
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.progress.completed
      name: Progress
      priority: 1
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          ArenaJob is the Schema for the arenajobs API.
          It defines a test execution that runs scenarios from an ArenaSource.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of ArenaJob
            properties:
              arenaFile:
                default: config.arena.yaml
                description: |-
                  arenaFile is the path to the arena config file within the source.
                  Supports glob patterns for multi-file configs (e.g., "evals/*.arena.yaml").
                type: string
              dataGen:
                description: |-
                  dataGen configures data generation settings.
                  Used when type is "datagen".
                properties:
                  count:
                    default: 100
                    description: count is the number of data items to generate.
                    format: int32
                    minimum: 1
                    type: integer
                  format:
                    default: jsonl
                    description: |-
                      format specifies the output format for generated data.
                      Supported formats: json, jsonl, csv
                    type: string
                type: object
              evaluation:
                description: |-
                  evaluation configures evaluation-specific settings.
                  Used when type is "evaluation".
                properties:
                  outputFormats:
                    description: |-
                      outputFormats specifies the formats for evaluation results.
                      Supported formats: junit, json, csv
                    items:
                      type: string
                    type: array
                type: object
              execution:
                description: |-
                  execution configures the execution mode and target.
                  If not specified, defaults to direct provider execution.
                properties:
                  mode:
                    default: direct
                    description: |-
                      mode selects the execution strategy.
                      "direct" calls LLM providers directly (existing behavior).
                      "fleet" connects to a deployed agent via WebSocket.
                    enum:
                    - direct
                    - fleet
                    type: string
                  target:
                    description: |-
                      target specifies the agent to test against.
                      Required when mode is "fleet".
                    properties:
                      agentRuntimeRef:
                        description: |-
                          agentRuntimeRef references the AgentRuntime CRD to connect to.
                          The controller resolves this to a WebSocket endpoint.
                        properties:
                          name:
                            description: name is the name of the object.
                            minLength: 1
                            type: string
                        required:
                        - name
                        type: object
                      namespace:
                        description: |-
                          namespace is the namespace of the AgentRuntime.
                          If not specified, defaults to the ArenaJob's namespace.
                        type: string
                    required:
                    - agentRuntimeRef
                    type: object
                type: object
                x-kubernetes-validations:
                - message: target is required when execution mode is fleet
                  rule: self.mode != 'fleet' || has(self.target)
              loadTest:
                description: |-
                  loadTest configures load testing settings.
                  Used when type is "loadtest".
                properties:
                  duration:
                    default: 5m
                    description: |-
                      duration is the total duration of the load test.
                      Format: duration string (e.g., "5m", "1h").
                    type: string
                  rampUp:
                    default: 30s
                    description: |-
                      rampUp is the duration to ramp up to target concurrency.
                      Format: duration string (e.g., "1m", "30s").
                    type: string
                  targetRPS:
                    description: targetRPS is the target requests per second.
                    format: int32
                    minimum: 1
                    type: integer
                type: object
              output:
                description: output configures where results are stored.
                properties:
                  pvc:
                    description: pvc configures PVC output. Required when type is
                      "pvc".
                    properties:
                      claimName:
                        description: claimName is the name of the PVC to use.
                        minLength: 1
                        type: string
                      subPath:
                        description: subPath is the subdirectory within the PVC.
                        type: string
                    required:
                    - claimName
                    type: object
                  s3:
                    description: s3 configures S3 output. Required when type is "s3".
                    properties:
                      bucket:
                        description: bucket is the S3 bucket name.
                        minLength: 1
                        type: string
                      endpoint:
                        description: endpoint is a custom S3-compatible endpoint URL.
                        type: string
                      prefix:
                        description: prefix is the key prefix for stored objects.
                        type: string
                      region:
                        description: region is the AWS region for the bucket.
                        type: string
                      secretRef:
                        description: |-
                          secretRef references a Secret containing S3 credentials.
                          Expected keys: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
                        properties:
                          name:
                            description: name is the name of the object.
                            minLength: 1
                            type: string
                        required:
                        - name
                        type: object
                    required:
                    - bucket
                    type: object
                  type:
                    description: type specifies the output destination type.
                    enum:
                    - s3
                    - pvc
                    type: string
                required:
                - type
                type: object
              providerOverrides:
                additionalProperties:
                  description: ProviderGroupSelector defines how to select Provider
                    CRDs for a specific group.
                  properties:
                    selector:
                      description: |-
                        selector is a label selector to match Provider CRDs in the workspace namespace.
                        All matching providers will be used for the group, with scenarios run against each.
                      properties:
                        matchExpressions:
                          description: matchExpressions is a list of label selector
                            requirements. The requirements are ANDed.
                          items:
                            description: |-
                              A label selector requirement is a selector that contains values, a key, and an operator that
                              relates the key and values.
                            properties:
                              key:
                                description: key is the label key that the selector
                                  applies to.
                                type: string
                              operator:
                                description: |-
                                  operator represents a key's relationship to a set of values.
                                  Valid operators are In, NotIn, Exists and DoesNotExist.
                                type: string
                              values:
                                description: |-
                                  values is an array of string values. If the operator is In or NotIn,
                                  the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                  the values array must be empty. This array is replaced during a strategic
                                  merge patch.
                                items:
                                  type: string
                                type: array
                                x-kubernetes-list-type: atomic
                            required:
                            - key
                            - operator
                            type: object
                          type: array
                          x-kubernetes-list-type: atomic
                        matchLabels:
                          additionalProperties:
                            type: string
                          description: |-
                            matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                            map is equivalent to an element of matchExpressions, whose key field is "key", the
                            operator is "In", and the values array contains only "value". The requirements are ANDed.
                          type: object
                      type: object
                      x-kubernetes-map-type: atomic
                  required:
                  - selector
                  type: object
                description: |-
                  providerOverrides allows overriding provider groups defined in the arena config file.
                  Keys are group names from the arena config file (e.g., "default", "judge").
                  Use "*" as a catch-all for groups not explicitly specified.
                  Provider CRDs matching the label selector provide credentials for the matched groups.
                type: object
              scenarios:
                description: |-
                  scenarios filters which scenarios to run from the arena file.
                  If not specified, runs all scenarios defined in the arena file.
                properties:
                  exclude:
                    description: |-
                      exclude specifies glob patterns for scenarios to exclude.
                      Exclusions are applied after inclusions.
                      Examples: ["*-wip.yaml", "scenarios/experimental/*"]
                    items:
                      type: string
                    type: array
                  include:
                    description: |-
                      include specifies glob patterns for scenarios to include.
                      If empty, all scenarios are included by default.
                      Examples: ["scenarios/*.yaml", "tests/billing-*.yaml"]
                    items:
                      type: string
                    type: array
                type: object
              schedule:
                description: |-
                  schedule configures scheduled/recurring execution.
                  If not specified, the job runs once immediately.
                properties:
                  concurrencyPolicy:
                    default: Forbid
                    description: concurrencyPolicy specifies how to treat concurrent
                      executions.
                    enum:
                    - Allow
                    - Forbid
                    - Replace
                    type: string
                  cron:
                    description: |-
                      cron is a cron expression for scheduled execution.
                      Format: standard cron expression (e.g., "0 2 * * *" for 2am daily).
                    minLength: 9
                    type: string
                  timezone:
                    default: UTC
                    description: timezone specifies the timezone for the cron schedule.
                    type: string
                type: object
              sourceRef:
                description: sourceRef references the ArenaSource containing test
                  scenarios and configuration.
                properties:
                  name:
                    description: name is the name of the object.
                    minLength: 1
                    type: string
                required:
                - name
                type: object
              toolRegistryOverride:
                description: |-
                  toolRegistryOverride allows overriding tools/mcp_servers defined in the arena config file
                  with handlers from ToolRegistry CRDs. All tools from matching registries will
                  override tools with matching names in the arena config.
                properties:
                  selector:
                    description: |-
                      selector is a label selector to match ToolRegistry CRDs in the workspace namespace.
                      All tools from matching registries will override tools/mcp_servers defined in arena.config.yaml.
                    properties:
                      matchExpressions:
                        description: matchExpressions is a list of label selector
                          requirements. The requirements are ANDed.
                        items:
                          description: |-
                            A label selector requirement is a selector that contains values, a key, and an operator that
                            relates the key and values.
                          properties:
                            key:
                              description: key is the label key that the selector
                                applies to.
                              type: string
                            operator:
                              description: |-
                                operator represents a key's relationship to a set of values.
                                Valid operators are In, NotIn, Exists and DoesNotExist.
                              type: string
                            values:
                              description: |-
                                values is an array of string values. If the operator is In or NotIn,
                                the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                the values array must be empty. This array is replaced during a strategic
                                merge patch.
                              items:
                                type: string
                              type: array
                              x-kubernetes-list-type: atomic
                          required:
                          - key
                          - operator
                          type: object
                        type: array
                        x-kubernetes-list-type: atomic
                      matchLabels:
                        additionalProperties:
                          type: string
                        description: |-
                          matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                          map is equivalent to an element of matchExpressions, whose key field is "key", the
                          operator is "In", and the values array contains only "value". The requirements are ANDed.
                        type: object
                    type: object
                    x-kubernetes-map-type: atomic
                required:
                - selector
                type: object
              ttlSecondsAfterFinished:
                description: ttlSecondsAfterFinished specifies how long to keep completed
                  jobs.
                format: int32
                minimum: 0
                type: integer
              type:
                default: evaluation
                description: type specifies the type of job to execute.
                enum:
                - evaluation
                - loadtest
                - datagen
                type: string
              verbose:
                description: |-
                  verbose enables verbose/debug logging for promptarena execution.
                  When enabled, workers will pass --verbose to promptarena for detailed output.
                type: boolean
              workers:
                description: workers configures the worker pool.
                properties:
                  maxReplicas:
                    description: maxReplicas is the maximum number of replicas for
                      autoscaling.
                    format: int32
                    minimum: 1
                    type: integer
                  minReplicas:
                    description: minReplicas is the minimum number of replicas for
                      autoscaling.
                    format: int32
                    minimum: 1
                    type: integer
                  replicas:
                    default: 1
                    description: replicas is the number of worker replicas.
                    format: int32
                    minimum: 1
                    type: integer
                type: object
            required:
            - sourceRef
            type: object
          status:
            description: status defines the observed state of ArenaJob
            properties:
              activeWorkers:
                description: activeWorkers is the current number of active workers.
                format: int32
                type: integer
              completionTime:
                description: completionTime is the timestamp when the job completed.
                format: date-time
                type: string
              conditions:
                description: conditions represent the current state of the job.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              lastScheduleTime:
                description: lastScheduleTime is the last time a scheduled job was
                  triggered.
                format: date-time
                type: string
              nextScheduleTime:
                description: nextScheduleTime is the next scheduled execution time.
                format: date-time
                type: string
              observedGeneration:
                description: observedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              phase:
                description: phase represents the current lifecycle phase of the job.
                enum:
                - Pending
                - Running
                - Succeeded
                - Failed
                - Cancelled
                type: string
              progress:
                description: progress tracks job execution progress.
                properties:
                  completed:
                    description: completed is the number of successfully completed
                      work items.
                    format: int32
                    type: integer
                  failed:
                    description: failed is the number of failed work items.
                    format: int32
                    type: integer
                  pending:
                    description: pending is the number of pending work items.
                    format: int32
                    type: integer
                  total:
                    description: total is the total number of work items.
                    format: int32
                    type: integer
                type: object
              result:
                description: result contains the job result summary.
                properties:
                  summary:
                    additionalProperties:
                      type: string
                    description: summary contains aggregated result metrics.
                    type: object
                  url:
                    description: url is the URL to access detailed results.
                    type: string
                type: object
              startTime:
                description: startTime is the timestamp when the job started.
                format: date-time
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
