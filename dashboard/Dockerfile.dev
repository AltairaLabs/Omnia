# Development Dockerfile for hot-reload with Tilt
#
# This runs the Next.js dev server instead of a production build,
# enabling hot module replacement when source files change.

FROM node:20-alpine

WORKDIR /app

# Install dependencies first for better caching
COPY package.json package-lock.json ./
RUN npm ci

# Copy source code
COPY . .

# Next.js dev server port and WebSocket proxy port
EXPOSE 3000 3002

# Environment for development
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1
ENV HOSTNAME="0.0.0.0"
# Limit V8 heap size to prevent OOM kills (75% of 2Gi container limit)
# Node.js doesn't automatically respect cgroup memory limits
ENV NODE_OPTIONS="--max-old-space-size=1536"

# Entrypoint ensures .next exists before starting dev server
# (Tilt sync can remove it)
CMD ["sh", "-c", "rm -rf .next && mkdir -p .next && npm run dev"]
