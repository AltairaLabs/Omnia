{{- if and .Values.demo.enabled .Values.demo.opa.enabled (eq .Values.demo.opa.mode "sidecar") }}
---
# Envoy Configuration for OPA Sidecar Mode
# Envoy acts as the entry point, calls OPA for authorization, then proxies to Ollama
apiVersion: v1
kind: ConfigMap
metadata:
  name: ollama-envoy-config
  namespace: {{ .Values.demo.namespace }}
  labels:
    app.kubernetes.io/name: ollama-envoy
    app.kubernetes.io/part-of: {{ include "omnia.name" . }}
data:
  envoy.yaml: |
    static_resources:
      listeners:
        - name: listener_0
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 11434
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: ollama_ingress
                    codec_type: AUTO
                    # Increase timeouts for LLM inference (can be slow)
                    request_timeout: 600s
                    stream_idle_timeout: 600s
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: ollama_backend
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/"
                              route:
                                cluster: ollama_cluster
                                timeout: 600s
                    http_filters:
                      # Buffer request body for OPA to inspect
                      - name: envoy.filters.http.buffer
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer
                          max_request_bytes: 1048576  # 1MB max body size
                      # External authorization via OPA
                      - name: envoy.filters.http.ext_authz
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                          transport_api_version: V3
                          grpc_service:
                            envoy_grpc:
                              cluster_name: opa_cluster
                            timeout: {{ .Values.demo.opa.extauthz.timeout | default "5s" }}
                          with_request_body:
                            max_request_bytes: 65536  # Send up to 64KB of body to OPA
                            allow_partial_message: true
                            pack_as_bytes: false
                          failure_mode_allow: {{ eq (.Values.demo.opa.extauthz.failureMode | default "DENY") "ALLOW" }}
                          status_on_error:
                            code: ServiceUnavailable
                      # Router must be last
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
        # Ollama backend (running on localhost:11435 in the same pod)
        - name: ollama_cluster
          connect_timeout: 30s
          type: STATIC
          lb_policy: ROUND_ROBIN
          load_assignment:
            cluster_name: ollama_cluster
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 11435
        # OPA ext_authz service (running on localhost:9191 in the same pod)
        - name: opa_cluster
          connect_timeout: 5s
          type: STATIC
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options: {}
          load_assignment:
            cluster_name: opa_cluster
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 9191

    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901
      access_log:
        - name: envoy.access_loggers.stdout
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
{{- end }}
