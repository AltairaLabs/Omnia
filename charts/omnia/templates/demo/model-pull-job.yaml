{{- if .Values.demo.enabled }}
# Job to pre-pull the Ollama model
# This runs after Ollama is ready and pulls the configured model
apiVersion: batch/v1
kind: Job
metadata:
  name: ollama-pull-model
  namespace: {{ .Values.demo.namespace }}
  labels:
    app.kubernetes.io/name: ollama
    app.kubernetes.io/component: model-pull
    app.kubernetes.io/part-of: {{ include "omnia.name" . }}
  annotations:
    # Run after Ollama is deployed
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ollama
        app.kubernetes.io/component: model-pull
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for Ollama to be ready
        - name: wait-for-ollama
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for Ollama to be ready..."
              until curl -sf http://ollama.{{ .Values.demo.namespace }}:11434/; do
                echo "Ollama not ready, waiting..."
                sleep 5
              done
              echo "Ollama is ready!"
      containers:
        - name: pull-model
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Pulling {{ .Values.demo.ollama.model }} model (this may take several minutes)..."
              curl -X POST http://ollama.{{ .Values.demo.namespace }}:11434/api/pull \
                -H "Content-Type: application/json" \
                -d '{"name": "{{ .Values.demo.ollama.model }}", "stream": false}' \
                --max-time 3600

              echo ""
              echo "Verifying model is available..."
              MODEL_NAME=$(echo "{{ .Values.demo.ollama.model }}" | cut -d: -f1)
              curl -s http://ollama.{{ .Values.demo.namespace }}:11434/api/tags | grep -q "$MODEL_NAME" && \
                echo "{{ .Values.demo.ollama.model }} model ready!" || \
                (echo "Failed to verify model" && exit 1)
{{- end }}
