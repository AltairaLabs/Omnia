---
/**
 * Version Switcher Component
 *
 * Displays a dropdown to switch between documentation versions.
 * Fetches version metadata from /versions.json at runtime.
 */
---

<div class="version-switcher">
  <label for="version-select" class="sr-only">Documentation version</label>
  <select
    id="version-select"
    class="version-select"
    aria-label="Select documentation version"
  >
    <option value="">Loading...</option>
  </select>
</div>

<style>
  .version-switcher {
    display: flex;
    align-items: center;
    margin-inline-end: 0.5rem;
  }

  .version-select {
    appearance: none;
    background-color: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    cursor: pointer;
    font-size: var(--sl-text-xs);
    font-weight: 500;
    padding: 0.375rem 1.75rem 0.375rem 0.625rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.375rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .version-select:hover {
    border-color: var(--sl-color-gray-4);
  }

  .version-select:focus {
    border-color: var(--sl-color-accent);
    box-shadow: 0 0 0 2px var(--sl-color-accent-low);
    outline: none;
  }

  .version-switcher.hidden {
    display: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  :global([data-theme='dark']) .version-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
  }
</style>

<script>
  interface Version {
    version: string;
    fullVersion: string;
    label: string;
    path: string;
    status: 'stable' | 'prerelease' | 'deprecated';
  }

  interface VersionsData {
    latest: string | null;
    latestPrerelease: string | null;
    versions: Version[];
  }

  // Determine current version from URL path
  // URLs like /v0-2/tutorials/getting-started -> version is "0.2"
  function getCurrentVersion(): string {
    const pathMatch = window.location.pathname.match(/^\/v(\d+)-(\d+)\//);
    return pathMatch ? `${pathMatch[1]}.${pathMatch[2]}` : 'latest';
  }

  // Convert version "0.2" to URL path format "/v0-2/"
  function versionToUrlPath(version: string): string {
    return `/v${version.replace('.', '-')}/`;
  }

  // Build target path for a version
  function buildTargetPath(targetPath: string, currentVersion: string): string {
    const currentPath = window.location.pathname;
    if (currentVersion === 'latest') {
      return targetPath + currentPath.slice(1);
    }
    return currentPath.replace(versionToUrlPath(currentVersion), targetPath);
  }

  async function initVersionSwitcher() {
    const container = document.querySelector('.version-switcher');
    const select = document.getElementById('version-select') as HTMLSelectElement;
    if (!select || !container) return;

    try {
      const response = await fetch('/versions.json');
      if (!response.ok) {
        container.classList.add('hidden');
        return;
      }

      const data: VersionsData = await response.json();
      const versions = data.versions || [];

      // If no versions, hide the switcher
      if (versions.length === 0) {
        container.classList.add('hidden');
        return;
      }

      const currentVersion = getCurrentVersion();

      // Determine the default version (latest stable, or latest prerelease if no stable)
      const latestVersion = versions[0]; // versions are sorted newest first

      // Clear loading option
      select.innerHTML = '';

      // Add version options (latest first)
      for (const v of versions) {
        const option = document.createElement('option');
        option.value = buildTargetPath(v.path, currentVersion);
        option.textContent = v.label;
        option.dataset.status = v.status;
        // Select if: user is on this version, OR user is on unversioned pages and this is latest
        if (v.version === currentVersion || (currentVersion === 'latest' && v === latestVersion)) {
          option.selected = true;
        }
        select.appendChild(option);
      }

      // Add "Current (dev)" option at the end
      const devOption = document.createElement('option');
      devOption.value = buildTargetPath('/', currentVersion);
      devOption.textContent = 'Current (dev)';
      devOption.dataset.status = 'prerelease';
      select.appendChild(devOption);

      // Handle selection change
      select.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        if (target.value) {
          window.location.href = target.value;
        }
      });
    } catch (error) {
      // On error, hide the switcher
      container.classList.add('hidden');
    }
  }

  // Run on page load
  initVersionSwitcher();
</script>
