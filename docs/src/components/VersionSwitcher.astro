---
/**
 * Version Switcher Component
 *
 * Displays a dropdown to switch between documentation versions.
 * Reads version metadata from /versions.json
 */
import versionsData from '../../versions.json';

interface Version {
  version: string;
  fullVersion: string;
  label: string;
  path: string;
  status: 'stable' | 'prerelease' | 'deprecated';
}

const versions: Version[] = versionsData.versions || [];
const currentPath = Astro.url.pathname;

// Determine current version from URL path
// URLs like /v0.2/tutorials/getting-started -> version is "0.2"
// URLs like /tutorials/getting-started -> version is "latest" (current dev)
const pathMatch = currentPath.match(/^\/v(\d+\.\d+)\//);
const currentVersion = pathMatch ? pathMatch[1] : 'latest';

// If no versions are published yet, don't render the switcher
const hasVersions = versions.length > 0;

// Build version options
const versionOptions = versions.map(v => ({
  ...v,
  isCurrent: v.version === currentVersion,
  // Convert current path to equivalent path in target version
  targetPath: currentVersion === 'latest'
    ? v.path + currentPath.slice(1)
    : currentPath.replace(`/v${currentVersion}/`, v.path)
}));

// Always add "Current (dev)" option for unversioned docs
const devOption = {
  version: 'latest',
  fullVersion: 'dev',
  label: 'Current (dev)',
  path: '/',
  status: 'prerelease' as const,
  isCurrent: currentVersion === 'latest',
  targetPath: currentVersion === 'latest'
    ? currentPath
    : currentPath.replace(`/v${currentVersion}/`, '/')
};

// Add dev option at the top
versionOptions.unshift(devOption);
---

<div class="version-switcher">
  <label for="version-select" class="sr-only">Documentation version</label>
  <select
    id="version-select"
    class="version-select"
    aria-label="Select documentation version"
  >
    {versionOptions.map(v => (
      <option
        value={v.targetPath}
        selected={v.isCurrent}
        data-status={v.status}
      >
        {v.label}
      </option>
    ))}
  </select>
</div>

<style>
  .version-switcher {
    display: flex;
    align-items: center;
    margin-inline-end: 0.5rem;
  }

  .version-select {
    appearance: none;
    background-color: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    cursor: pointer;
    font-size: var(--sl-text-xs);
    font-weight: 500;
    padding: 0.375rem 1.75rem 0.375rem 0.625rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.375rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .version-select:hover {
    border-color: var(--sl-color-gray-4);
  }

  .version-select:focus {
    border-color: var(--sl-color-accent);
    box-shadow: 0 0 0 2px var(--sl-color-accent-low);
    outline: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Dark mode adjustments */
  :global([data-theme='dark']) .version-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
  }
</style>

<script>
  // Handle version selection
  const select = document.getElementById('version-select') as HTMLSelectElement;
  if (select) {
    select.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      if (target.value) {
        window.location.href = target.value;
      }
    });
  }
</script>
