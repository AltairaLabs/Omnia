---
/**
 * Version Switcher Component
 *
 * Displays a dropdown to switch between documentation versions.
 * - Local dev (no versions.json or current=null): shows "dev" only
 * - Released docs: shows "Latest (vX.X)" + any archived versions
 */
---

<div class="version-switcher">
  <label for="version-select" class="sr-only">Documentation version</label>
  <select
    id="version-select"
    class="version-select"
    aria-label="Select documentation version"
  >
    <option value="">Loading...</option>
  </select>
</div>

<style>
  .version-switcher {
    display: flex;
    align-items: center;
    margin-inline-end: 0.5rem;
  }

  .version-select {
    appearance: none;
    background-color: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    cursor: pointer;
    font-size: var(--sl-text-xs);
    font-weight: 500;
    padding: 0.375rem 1.75rem 0.375rem 0.625rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.375rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .version-select:hover {
    border-color: var(--sl-color-gray-4);
  }

  .version-select:focus {
    border-color: var(--sl-color-accent);
    box-shadow: 0 0 0 2px var(--sl-color-accent-low);
    outline: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  :global([data-theme='dark']) .version-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
  }
</style>

<script>
  interface VersionEntry {
    version: string;
    fullVersion: string;
    label: string;
    path: string;
    status: 'stable' | 'prerelease' | 'archived' | 'deprecated';
  }

  interface VersionsData {
    current: VersionEntry | null;
    archived: VersionEntry[];
  }

  async function initVersionSwitcher() {
    const select = document.getElementById('version-select') as HTMLSelectElement;
    if (!select) return;

    // Default to "dev" if versions.json unavailable or has no current version
    const showDevOnly = () => {
      select.innerHTML = '';
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'dev';
      option.selected = true;
      option.disabled = true;
      select.appendChild(option);
    };

    try {
      const response = await fetch('/versions.json');
      if (!response.ok) {
        showDevOnly();
        return;
      }

      const data: VersionsData = await response.json();

      // If no current version (local dev), show "dev" only
      if (!data.current) {
        showDevOnly();
        return;
      }

      // Clear loading option
      select.innerHTML = '';

      // Detect if we're on an archived version by checking the URL path
      const currentPath = window.location.pathname;
      const archiveMatch = currentPath.match(/^\/(v\d+-\d+)\//);
      const currentArchivePath = archiveMatch ? `/${archiveMatch[1]}/` : null;

      // Add current version (at root)
      const currentOption = document.createElement('option');
      currentOption.value = '/';
      currentOption.textContent = data.current.label;
      currentOption.selected = !currentArchivePath; // Selected if we're not on an archive
      select.appendChild(currentOption);

      // Add archived versions
      if (data.archived && data.archived.length > 0) {
        for (const v of data.archived) {
          const option = document.createElement('option');
          option.value = v.path;
          option.textContent = v.label;
          option.selected = v.path === currentArchivePath;
          select.appendChild(option);
        }
      }

      // Handle selection change - navigate to selected version
      select.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        const selectedPath = target.value;

        // Get the page path without version prefix
        let pagePath = currentPath;
        if (currentArchivePath) {
          pagePath = currentPath.replace(currentArchivePath, '/');
        }

        // Navigate to the selected version
        if (selectedPath === '/') {
          window.location.href = pagePath;
        } else {
          window.location.href = selectedPath + pagePath.slice(1);
        }
      });
    } catch {
      // On error (e.g., local dev with no server), show "dev" only
      showDevOnly();
    }
  }

  // Run on page load
  initVersionSwitcher();
</script>
