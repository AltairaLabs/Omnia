---
import { getCollection } from 'astro:content';

interface Props {
  section?: string;
  currentPath: string;
}

const { section, currentPath } = Astro.props;

// Helper function to properly join base URL with path
const joinPath = (path: string) => {
  const base = import.meta.env.BASE_URL;
  if (base === '/') {
    return path.startsWith('/') ? path : `/${path}`;
  }
  const cleanBase = base.endsWith('/') ? base.slice(0, -1) : base;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${cleanBase}${cleanPath}`;
};

// Get all docs for the current section
let docs: any[] = [];
if (section) {
  try {
    docs = await getCollection(section as any);
  } catch (e) {
    docs = [];
  }
}

// Sort docs by order then title
docs.sort((a, b) => {
  if (a.data.order !== undefined && b.data.order !== undefined) {
    return a.data.order - b.data.order;
  }
  if (a.data.order !== undefined) return -1;
  if (b.data.order !== undefined) return 1;
  return a.data.title.localeCompare(b.data.title);
});

// Section titles
const sectionTitles: Record<string, string> = {
  'tutorials': 'Tutorials',
  'how-to': 'How-To Guides',
  'reference': 'Reference',
  'explanation': 'Concepts',
};
---

<nav class="sidebar-nav">
  {section && (
    <div class="sidebar-header">
      <h2>{sectionTitles[section] || section}</h2>
    </div>
  )}

  <ul>
    {docs.map(doc => {
      const href = joinPath(`/${section}/${doc.slug}/`);
      const isActive = currentPath.includes(doc.slug);
      return (
        <li>
          <a href={href} class={isActive ? 'active' : ''}>
            {doc.data.title}
          </a>
        </li>
      );
    })}
  </ul>

  {docs.length === 0 && section && (
    <p class="sidebar-empty">No documentation available yet.</p>
  )}
</nav>

<style>
  .sidebar-nav {
    font-size: 0.875rem;
  }

  .sidebar-header h2 {
    margin: 0 0 1.5rem 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  li {
    margin: 0;
  }

  a {
    display: block;
    padding: 0.375rem 0.75rem;
    color: var(--color-text);
    text-decoration: none;
    border-radius: 6px;
    transition: background-color 0.2s;
  }

  a:hover {
    background-color: rgba(175, 184, 193, 0.1);
    text-decoration: none;
  }

  a.active {
    background-color: rgba(124, 58, 237, 0.1);
    font-weight: 600;
    color: var(--color-accent);
  }

  @media (prefers-color-scheme: dark) {
    a.active {
      background-color: rgba(167, 139, 250, 0.1);
    }
  }

  .sidebar-empty {
    color: #57606a;
    font-size: 0.875rem;
  }

  @media (prefers-color-scheme: dark) {
    .sidebar-empty {
      color: #8b949e;
    }
  }
</style>
