name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  # GHCR requires lowercase - github.repository_owner may have mixed case
  CHART_REGISTRY: ghcr.io/altairalabs/charts

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

# Use same concurrency group as docs.yml to prevent race conditions
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  parse-version:
    name: Parse Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}
      major: ${{ steps.parse.outputs.major }}
      minor: ${{ steps.parse.outputs.minor }}
      patch: ${{ steps.parse.outputs.patch }}
      prerelease_tag: ${{ steps.parse.outputs.prerelease_tag }}
    steps:
      - name: Parse version from tag
        id: parse
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Detect prerelease (contains hyphen followed by alpha/beta/rc)
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            # Extract prerelease tag (e.g., "alpha.1" from "0.2.0-alpha.1")
            PRERELEASE_TAG="${VERSION#*-}"
            echo "prerelease_tag=$PRERELEASE_TAG" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "prerelease_tag=" >> $GITHUB_OUTPUT
          fi

          # Extract semver components (strip prerelease suffix first)
          BASE_VERSION="${VERSION%%-*}"
          IFS='.' read -r major minor patch <<< "$BASE_VERSION"
          echo "major=$major" >> $GITHUB_OUTPUT
          echo "minor=$minor" >> $GITHUB_OUTPUT
          echo "patch=$patch" >> $GITHUB_OUTPUT

          echo "Parsed version: $VERSION"
          echo "  Major: $major, Minor: $minor, Patch: $patch"
          echo "  Is prerelease: $([[ "$VERSION" =~ -[a-zA-Z] ]] && echo true || echo false)"

  docker-release:
    name: Build & Push Docker Images
    needs: parse-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image: omnia
            dockerfile: Dockerfile
            context: .
          - image: omnia-facade
            dockerfile: Dockerfile.agent
            context: .
          - image: omnia-runtime
            dockerfile: Dockerfile.runtime
            context: .
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.parse-version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.parse-version.outputs.version }},enable=${{ needs.parse-version.outputs.is_prerelease == 'false' }}
            type=raw,value=latest,enable=${{ needs.parse-version.outputs.is_prerelease == 'false' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  helm-release:
    name: Package & Push Helm Chart
    needs: [parse-version, docker-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update Chart.yaml versions
        run: |
          VERSION="${{ needs.parse-version.outputs.version }}"

          # Update chart version and appVersion
          yq eval -i ".version = \"$VERSION\"" charts/omnia/Chart.yaml
          yq eval -i ".appVersion = \"$VERSION\"" charts/omnia/Chart.yaml

          echo "Updated Chart.yaml:"
          cat charts/omnia/Chart.yaml

      - name: Update dependencies
        run: helm dependency update charts/omnia

      - name: Lint chart
        run: helm lint charts/omnia

      - name: Package Helm chart
        run: |
          mkdir -p dist
          helm package charts/omnia --destination dist/

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Push to GHCR OCI Registry
        run: |
          VERSION="${{ needs.parse-version.outputs.version }}"
          helm push dist/omnia-${VERSION}.tgz oci://${{ env.CHART_REGISTRY }}

      - name: Upload chart artifact
        uses: actions/upload-artifact@v7
        with:
          name: helm-chart
          path: dist/omnia-*.tgz

  docs-build:
    name: Build Documentation
    needs: parse-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Install D2
        run: curl -fsSL https://d2lang.com/install.sh | sh -s --

      - name: Check if archiving is needed
        id: archive-check
        run: |
          NEW_MINOR="${{ needs.parse-version.outputs.major }}.${{ needs.parse-version.outputs.minor }}"

          # Get current deployed version from live site
          LIVE_VERSIONS=$(curl -sf https://omnia.altairalabs.ai/versions.json || echo '{"current":null}')
          CURRENT_MINOR=$(echo "$LIVE_VERSIONS" | jq -r '.current.version // empty')

          echo "Current deployed minor: $CURRENT_MINOR"
          echo "New release minor: $NEW_MINOR"

          if [ -n "$CURRENT_MINOR" ] && [ "$CURRENT_MINOR" != "$NEW_MINOR" ]; then
            echo "Minor version changed - archiving needed"
            echo "needs_archive=true" >> $GITHUB_OUTPUT
            echo "archive_minor=$CURRENT_MINOR" >> $GITHUB_OUTPUT

            # Find the last tag for the old minor version
            ARCHIVE_TAG=$(git tag -l "v${CURRENT_MINOR}.*" | sort -V | tail -1)
            echo "Archive tag: $ARCHIVE_TAG"
            echo "archive_tag=$ARCHIVE_TAG" >> $GITHUB_OUTPUT

            # Convert version to path: 0.2 -> v0-2
            ARCHIVE_PATH="v${CURRENT_MINOR//./-}"
            echo "archive_path=$ARCHIVE_PATH" >> $GITHUB_OUTPUT
          else
            echo "Same minor version - no archiving needed"
            echo "needs_archive=false" >> $GITHUB_OUTPUT
          fi

      - name: Build archived version
        if: steps.archive-check.outputs.needs_archive == 'true'
        run: |
          ARCHIVE_TAG="${{ steps.archive-check.outputs.archive_tag }}"
          ARCHIVE_PATH="${{ steps.archive-check.outputs.archive_path }}"

          echo "Building archived docs from $ARCHIVE_TAG at /$ARCHIVE_PATH/"

          # Save current commit
          CURRENT_SHA=$(git rev-parse HEAD)

          # Checkout the old tag
          git checkout "$ARCHIVE_TAG"

          # Install dependencies for old version
          cd docs && npm ci

          # Build with archive base path
          BASE_PATH="/$ARCHIVE_PATH" npm run build

          # Save the archived build
          mv dist "../archived-${ARCHIVE_PATH}"
          cd ..

          # Return to current commit
          git checkout "$CURRENT_SHA"

          echo "Archived build saved to archived-${ARCHIVE_PATH}"

      - name: Download existing archives from live site
        run: |
          mkdir -p existing-archives

          # Get list of existing archived versions
          LIVE_VERSIONS=$(curl -sf https://omnia.altairalabs.ai/versions.json || echo '{"archived":[]}')
          ARCHIVED=$(echo "$LIVE_VERSIONS" | jq -r '.archived[].path // empty' | sed 's|^/||')

          for archive_path in $ARCHIVED; do
            if [ -n "$archive_path" ]; then
              echo "Downloading existing archive: $archive_path"
              mkdir -p "existing-archives/$archive_path"
              # Use wget to mirror the archive directory
              wget -q -r -np -nH --cut-dirs=1 -P "existing-archives/$archive_path" \
                "https://omnia.altairalabs.ai/$archive_path/" || true
            fi
          done

      - name: Install dependencies
        run: cd docs && npm ci

      - name: Update versions.json
        run: |
          NEEDS_ARCHIVE="${{ steps.archive-check.outputs.needs_archive }}"
          ARCHIVE_MINOR="${{ steps.archive-check.outputs.archive_minor }}"
          ARCHIVE_PATH="${{ steps.archive-check.outputs.archive_path }}"

          node scripts/update-versions.js \
            "${{ needs.parse-version.outputs.version }}" \
            "${{ needs.parse-version.outputs.is_prerelease }}" \
            "$NEEDS_ARCHIVE" \
            "$ARCHIVE_MINOR" \
            "$ARCHIVE_PATH"

      - name: Build documentation
        run: cd docs && npm run build

      - name: Merge archived docs into build
        run: |
          # Copy newly archived version if created
          if [ -d "archived-${{ steps.archive-check.outputs.archive_path }}" ]; then
            echo "Adding newly archived version: ${{ steps.archive-check.outputs.archive_path }}"
            cp -r "archived-${{ steps.archive-check.outputs.archive_path }}" \
              "docs/dist/${{ steps.archive-check.outputs.archive_path }}"
          fi

          # Copy existing archives
          if [ -d "existing-archives" ] && [ "$(ls -A existing-archives 2>/dev/null)" ]; then
            echo "Adding existing archives:"
            ls -la existing-archives/
            cp -r existing-archives/* docs/dist/ 2>/dev/null || true
          fi

          echo "Final build contents:"
          ls -la docs/dist/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/dist

  docs-deploy:
    name: Deploy Documentation
    needs: docs-build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  github-release:
    name: Create GitHub Release
    needs: [parse-version, docker-release, helm-release, docs-deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Helm chart artifact
        uses: actions/download-artifact@v7
        with:
          name: helm-chart
          path: dist/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.parse-version.outputs.version }}"
          IS_PRERELEASE="${{ needs.parse-version.outputs.is_prerelease }}"

          cat << 'EOF' > release-notes.md
          ## Installation

          ### Helm (Recommended)

          ```bash
          helm install omnia oci://ghcr.io/altairalabs/charts/omnia \
            --version ${{ needs.parse-version.outputs.version }} \
            --namespace omnia-system \
            --create-namespace
          ```

          ### Docker Images

          - `ghcr.io/altairalabs/omnia:${{ needs.parse-version.outputs.version }}` (operator)
          - `ghcr.io/altairalabs/omnia-facade:${{ needs.parse-version.outputs.version }}` (agent facade)
          - `ghcr.io/altairalabs/omnia-runtime:${{ needs.parse-version.outputs.version }}` (agent runtime)

          ## Documentation

          EOF

          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "- [Pre-release Documentation](https://omnia.altairalabs.ai)" >> release-notes.md
          else
            echo "- [v${{ needs.parse-version.outputs.major }}.${{ needs.parse-version.outputs.minor }} Documentation](https://omnia.altairalabs.ai)" >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "## What's Changed" >> release-notes.md
          echo "" >> release-notes.md
          echo "See full changelog below." >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.parse-version.outputs.version }}
          body_path: release-notes.md
          prerelease: ${{ needs.parse-version.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            dist/omnia-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
