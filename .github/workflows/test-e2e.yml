name: E2E Tests

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile*'
      - 'api/**'
      - 'cmd/**'
      - 'config/**'
      - 'internal/**'
      - 'pkg/**'
      - 'test/**'
      - 'hack/**'
      - '.github/workflows/test-e2e.yml'
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile*'
      - 'api/**'
      - 'cmd/**'
      - 'config/**'
      - 'internal/**'
      - 'pkg/**'
      - 'test/**'
      - 'hack/**'
      - '.github/workflows/test-e2e.yml'

permissions:
  contents: read
  checks: write

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  test-e2e:
    name: Run on Ubuntu
    runs-on: ubuntu-latest
    # E2E tests are informational for PRs - they don't block merging
    # They only block releases (enforced in release workflow)
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Clone the code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Running Test e2e
        run: |
          # Skip go mod tidy - may fail on local replace directives for PromptKit
          make test-e2e-junit

      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: 'e2e-results.xml'
          check_name: 'E2E Test Results'
          detailed_summary: true
          include_passed: true

      - name: Generate Timing Summary
        if: always()
        run: |
          if [ -f e2e-results.xml ]; then
            echo "## ⏱️ E2E Test Timing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Extract test names and times from JUnit XML
            echo "| Test | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
            grep -oP 'name="[^"]*"[^>]*time="[^"]*"' e2e-results.xml | \
              sed 's/name="\([^"]*\)".*time="\([^"]*\)"/| \1 | \2s |/' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Total time
            TOTAL=$(grep -oP 'time="[^"]*"' e2e-results.xml | head -1 | grep -oP '[0-9.]+')
            echo "**Total Duration: ${TOTAL}s**" >> $GITHUB_STEP_SUMMARY
          fi
