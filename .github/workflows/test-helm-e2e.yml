name: Helm E2E Tests

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/test-helm-e2e.yml'
  pull_request:
    paths:
      - 'charts/**'
      - '.github/workflows/test-helm-e2e.yml'

permissions:
  contents: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  KIND_CLUSTER: helm-e2e-test
  HELM_VERSION: v3.14.0

jobs:
  helm-e2e:
    name: Helm Chart Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Create kind cluster
        run: |
          kind create cluster --name $KIND_CLUSTER --wait 60s
          kubectl cluster-info --context kind-$KIND_CLUSTER

      - name: Install cert-manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
          echo "Waiting for cert-manager to be ready..."
          kubectl wait --for=condition=Available deployment/cert-manager -n cert-manager --timeout=120s
          kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=120s
          kubectl wait --for=condition=Available deployment/cert-manager-cainjector -n cert-manager --timeout=120s

      - name: Install Gateway API CRDs
        run: |
          kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml

      - name: Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add kedacore https://kedacore.github.io/charts
          helm repo update

      - name: Build chart dependencies
        run: |
          helm dependency build ./charts/omnia

      - name: Test - Basic Helm template validation
        run: |
          echo "=== Testing helm template generation ==="
          helm template omnia ./charts/omnia --debug > /dev/null
          echo "Template generation successful"

      - name: Test - Helm install with KEDA subchart disabled
        run: |
          echo "=== Testing basic install (keda.enabled=false) ==="
          # Note: We don't use --wait because the container images may not be available in CI
          # This test validates that Helm can render and apply the manifests correctly
          helm install omnia ./charts/omnia \
            --namespace omnia-system \
            --create-namespace \
            --set keda.enabled=false \
            --timeout 2m

          echo "Verifying resources were created..."
          kubectl get deployments -n omnia-system
          kubectl get services -n omnia-system
          kubectl get serviceaccounts -n omnia-system

          # Verify CRDs were installed
          kubectl get crd agentruntimes.omnia.altairalabs.ai
          kubectl get crd providers.omnia.altairalabs.ai

          echo "Basic install successful - all resources created"

      - name: Test - Helm upgrade
        run: |
          echo "=== Testing helm upgrade ==="
          helm upgrade omnia ./charts/omnia \
            --namespace omnia-system \
            --set keda.enabled=false \
            --timeout 2m

          echo "Upgrade successful"

      - name: Test - Uninstall for next test
        run: |
          helm uninstall omnia -n omnia-system
          # Give time for resources to be deleted
          sleep 5
          kubectl delete namespace omnia-system --wait=true --timeout=60s || true

      - name: Test - KEDA conflict detection
        run: |
          echo "=== Testing KEDA conflict detection ==="

          # First, install KEDA separately (with --wait since we need it running)
          echo "Installing KEDA separately..."
          helm install keda kedacore/keda \
            --namespace keda \
            --create-namespace \
            --wait \
            --timeout 5m

          # Verify KEDA CRD exists
          kubectl get crd scaledobjects.keda.sh

          # Now try to install omnia with keda.enabled=true - should FAIL
          echo "Attempting to install omnia with keda.enabled=true (should fail)..."
          set +e  # Don't exit on error
          helm install omnia ./charts/omnia \
            --namespace omnia-system \
            --create-namespace \
            --set keda.enabled=true \
            --timeout 1m 2>&1 | tee /tmp/helm-output.txt
          HELM_EXIT_CODE=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error

          if [ $HELM_EXIT_CODE -eq 0 ]; then
            echo "ERROR: Installation should have failed but succeeded!"
            exit 1
          fi
          echo "Helm install failed as expected (exit code: $HELM_EXIT_CODE)"

          # Verify we got the expected error message
          if grep -q "KEDA is already installed" /tmp/helm-output.txt; then
            echo "Got expected KEDA conflict error message"
          else
            echo "ERROR: Did not get expected KEDA conflict error message"
            cat /tmp/helm-output.txt
            exit 1
          fi

          # Now install with keda.enabled=false - should SUCCEED
          echo "Installing omnia with keda.enabled=false (should succeed)..."
          helm install omnia ./charts/omnia \
            --namespace omnia-system \
            --create-namespace \
            --set keda.enabled=false \
            --timeout 2m

          echo "KEDA conflict detection test passed!"

      - name: Test - Verify ScaledObject works with external KEDA
        run: |
          echo "=== Testing ScaledObject with external KEDA ==="

          # Create a test ScaledObject to verify it works with external KEDA
          cat <<EOF | kubectl apply -f -
          apiVersion: keda.sh/v1alpha1
          kind: ScaledObject
          metadata:
            name: test-scaledobject
            namespace: omnia-system
          spec:
            scaleTargetRef:
              name: omnia-controller-manager
            minReplicaCount: 1
            maxReplicaCount: 3
            triggers:
              - type: cpu
                metadata:
                  type: Utilization
                  value: "80"
          EOF

          # Verify ScaledObject was created
          kubectl get scaledobject test-scaledobject -n omnia-system
          echo "ScaledObject creation successful with external KEDA"

      - name: Test - Uninstall for observability test
        run: |
          helm uninstall omnia -n omnia-system || true
          helm uninstall keda -n keda || true
          sleep 5
          kubectl delete namespace omnia-system --wait=true --timeout=120s || true
          kubectl delete namespace keda --wait=true --timeout=60s || true

          # Wait for namespace to be fully terminated
          echo "Waiting for namespaces to be fully deleted..."
          for i in {1..30}; do
            if ! kubectl get namespace omnia-system 2>/dev/null; then
              echo "Namespace omnia-system deleted"
              break
            fi
            echo "Waiting for omnia-system namespace to terminate... ($i/30)"
            sleep 2
          done

      - name: Test - Observability stack deployment
        run: |
          echo "=== Testing observability stack (Prometheus, Grafana, Loki) ==="

          # Install with observability components enabled
          helm install omnia ./charts/omnia \
            --namespace omnia-system \
            --create-namespace \
            --set keda.enabled=false \
            --set prometheus.enabled=true \
            --set grafana.enabled=true \
            --set loki.enabled=true \
            --timeout 5m

          echo "Waiting for observability pods to be created..."
          sleep 30

          echo "=== Checking Prometheus ==="
          kubectl get pods -n omnia-system -l "app.kubernetes.io/name=prometheus" || kubectl get pods -n omnia-system | grep prometheus || true
          kubectl get svc -n omnia-system | grep prometheus || true

          echo "=== Checking Grafana ==="
          kubectl get pods -n omnia-system -l "app.kubernetes.io/name=grafana" || kubectl get pods -n omnia-system | grep grafana || true
          kubectl get svc -n omnia-system | grep grafana || true

          echo "=== Checking Loki ==="
          kubectl get pods -n omnia-system -l "app.kubernetes.io/name=loki" || kubectl get pods -n omnia-system | grep loki || true
          kubectl get svc -n omnia-system | grep loki || true

          # Verify key services exist
          echo "=== Verifying key services ==="
          kubectl get svc -n omnia-system

          # Check that Loki pod is not in CrashLoopBackOff (ruler fix verification)
          echo "=== Verifying Loki is not crashing ==="
          sleep 30  # Give pods time to potentially crash
          LOKI_STATUS=$(kubectl get pods -n omnia-system -l "app.kubernetes.io/name=loki" -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "unknown")
          echo "Loki pod status: $LOKI_STATUS"

          # Check for CrashLoopBackOff
          if kubectl get pods -n omnia-system | grep -i loki | grep -q "CrashLoopBackOff"; then
            echo "ERROR: Loki is in CrashLoopBackOff!"
            kubectl logs -n omnia-system -l "app.kubernetes.io/name=loki" --tail=50 || true
            exit 1
          fi

          echo "Observability stack deployment successful!"

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name $KIND_CLUSTER || true

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add kedacore https://kedacore.github.io/charts
          helm repo update

      - name: Build chart dependencies
        run: |
          helm dependency build ./charts/omnia

      - name: Lint chart
        run: |
          helm lint ./charts/omnia

      - name: Validate chart metadata
        run: |
          echo "=== Validating Chart.yaml ==="
          cat ./charts/omnia/Chart.yaml

          # Check required fields
          grep -q "^name:" ./charts/omnia/Chart.yaml
          grep -q "^version:" ./charts/omnia/Chart.yaml
          grep -q "^appVersion:" ./charts/omnia/Chart.yaml

          echo "Chart metadata validation passed"
