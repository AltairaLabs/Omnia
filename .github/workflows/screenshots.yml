name: Screenshots

on:
  workflow_dispatch:
    inputs:
      commit_screenshots:
        description: 'Commit screenshots to branch'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  capture:
    name: Capture Screenshots
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json

    - name: Install dependencies
      run: npm ci
      working-directory: dashboard

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      working-directory: dashboard

    - name: Install ffmpeg for GIF conversion
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Build dashboard
      run: npm run build
      working-directory: dashboard
      env:
        NEXT_PUBLIC_DEMO_MODE: 'true'

    - name: Start dashboard server
      run: |
        npm run start &
        sleep 5
        curl -s http://localhost:3000 > /dev/null || (echo "Server failed to start" && exit 1)
      working-directory: dashboard
      env:
        PORT: 3000
        DEMO_MODE: 'true'

    - name: Capture screenshots
      run: npx playwright test --project=screenshots --reporter=list
      working-directory: dashboard
      env:
        CI: true

    - name: Capture videos
      run: npx playwright test --project=video-capture --reporter=list
      working-directory: dashboard
      env:
        CI: true
      continue-on-error: true

    - name: Convert videos to GIFs
      run: |
        cd dashboard/e2e/test-results
        mkdir -p ../../docs/src/assets/screenshots

        for video_dir in *video-capture*; do
          if [ -d "$video_dir" ] && [ -f "$video_dir/video.webm" ]; then
            # Extract test name from directory
            name=$(echo "$video_dir" | sed 's/.*Animation-Captures-//' | sed 's/-video-capture$//' | tr '-' '_')
            echo "Converting $video_dir/video.webm to $name.gif..."

            ffmpeg -y -i "$video_dir/video.webm" \
              -vf "fps=15,scale=800:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=256[p];[s1][p]paletteuse=dither=bayer" \
              -loop 0 \
              "../../docs/src/assets/screenshots/$name.gif" || echo "Failed to convert $name"
          fi
        done
      working-directory: ${{ github.workspace }}

    - name: List captured files
      run: |
        echo "=== Screenshots ==="
        ls -la docs/src/assets/screenshots/ || echo "No screenshots found"
        echo ""
        echo "=== Test Results ==="
        ls -la dashboard/e2e/test-results/ || echo "No test results"

    - name: Upload screenshots artifact
      uses: actions/upload-artifact@v7
      with:
        name: screenshots
        path: docs/src/assets/screenshots/
        retention-days: 30

    - name: Upload test results artifact
      uses: actions/upload-artifact@v7
      with:
        name: test-results
        path: dashboard/e2e/test-results/
        retention-days: 7

    - name: Commit screenshots
      if: ${{ inputs.commit_screenshots }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add docs/src/assets/screenshots/

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update dashboard screenshots

          Automatically generated screenshots from Playwright tests.

          Generated by GitHub Actions workflow."
          git push
        fi
